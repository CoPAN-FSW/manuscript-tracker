<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manuscript Tracker</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20viewBox%3D'0%200%2064%2064'%3E%3Crect%20x%3D'4'%20y%3D'4'%20width%3D'56'%20height%3D'56'%20rx%3D'12'%20fill%3D'%23f3f4f6'%2F%3E%3Cpath%20d%3D'M14%2048V18H19.5L24%2032L28.5%2018H34V48H29V27.5L24.5%2038.5L20%2027.5V48H14Z'%20fill%3D'%23111827'%2F%3E%3Cpath%20d%3D'M37%2020H51V24H45.5V48H41V24H37V20Z'%20fill%3D'%23111827'%2F%3E%3C%2Fsvg%3E">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: #f9fafb;
            color: #0a0a0a;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        header {
            margin-bottom: 48px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            border-radius: 11px;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .logo-icon svg {
            width: 30px;
            height: 30px;
        }

        h1 {
            font-size: 26px;
            font-weight: 600;
            color: #0a0a0a;
            letter-spacing: -0.02em;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 40px;
            align-items: center;
        }

        .search-box {
            flex: 1;
            max-width: 380px;
        }

        .sort-box {
            min-width: 200px;
        }

        .sort-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            color: #171717;
            cursor: pointer;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .sort-select:focus {
            outline: none;
            border-color: #171717;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23a3a3a3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 16px center;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #171717;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04);
        }

        .search-input::placeholder {
            color: #999;
        }

        .btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            color: #171717;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #fafafa;
            border-color: #a3a3a3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .btn-primary {
            background: #171717;
            border-color: #171717;
            color: white;
        }

        .btn-primary:hover {
            background: #262626;
            border-color: #262626;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .manuscripts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .card {
            background: white;
            border: 1px solid #e5e5e5;
            border-left: 3px solid #e5e5e5;
            border-radius: 14px;
            padding: 28px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .card.card-reminder {
            border-color: #fed7aa;
            border-left-color: #f97316;
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.35), rgba(255, 255, 255, 0.95));
        }

        .card:hover {
            border-color: #d4d4d4;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .card[data-status="draft"] { border-left-color: #737373; }
        .card[data-status="submitted"] { border-left-color: #2563eb; }
        .card[data-status="review"] { border-left-color: #d97706; }
        .card[data-status="revising"] { border-left-color: #7c3aed; }
        .card[data-status="accepted"] { border-left-color: #059669; }
        .card[data-status="rejected"] { border-left-color: #dc2626; }
        .card[data-status="published"] { border-left-color: #0891b2; }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #0a0a0a;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        .card-journal {
            font-size: 14px;
            color: #525252;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .card-date {
            font-size: 13px;
            color: #a3a3a3;
            margin-bottom: 18px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-draft { background: #f5f5f5; color: #525252; }
        .status-submitted { background: #dbeafe; color: #1e40af; }
        .status-review { background: #fed7aa; color: #92400e; }
        .status-revising { background: #ede9fe; color: #6d28d9; }
        .status-accepted { background: #d1fae5; color: #047857; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-published { background: #cffafe; color: #0e7490; }

        .card-notes {
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
            color: #525252;
            line-height: 1.6;
        }

        .card-tags {
            margin-top: 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
            background: #e0e7ff;
            border: 1px solid #c7d2fe;
            letter-spacing: 0.02em;
        }

        .reminder-badge {
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            background: #fef3c7;
            color: #92400e;
            font-size: 12px;
            font-weight: 600;
        }

        .reminder-badge svg {
            width: 14px;
            height: 14px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 22px;
        }

        .btn-card {
            flex: 1;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            color: #525252;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-card:hover {
            background: white;
            color: #0a0a0a;
            border-color: #a3a3a3;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .btn-delete:hover {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fca5a5;
            box-shadow: 0 1px 4px rgba(220, 38, 38, 0.15);
        }

        .empty {
            text-align: center;
            padding: 120px 20px;
        }

        .empty svg {
            width: 64px;
            height: 64px;
            opacity: 0.12;
            margin-bottom: 28px;
        }

        .empty h3 {
            font-size: 18px;
            font-weight: 600;
            color: #525252;
            margin-bottom: 10px;
            letter-spacing: -0.01em;
        }

        .empty p {
            font-size: 14px;
            color: #a3a3a3;
            line-height: 1.6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 36px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2), 0 8px 16px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 28px;
            color: #0a0a0a;
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #262626;
            letter-spacing: -0.01em;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 11px 14px;
            background: white;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.15s ease;
            color: #0a0a0a;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #171717;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .form-textarea {
            min-height: 88px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-select {
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .form-hint {
            margin-top: 6px;
            font-size: 12px;
            color: #737373;
        }

        .credits {
            margin: 140px auto 30px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .credits-subline {
            margin: 8px auto 40px;
            font-size: 11px;
            letter-spacing: 0.08em;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            text-transform: none;
            color: #9ca3af;
        }

        .credits-heart {
            width: 17px;
            height: 17px;
            fill: none;
            stroke: #6b7280;
            stroke-width: 2;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 28px;
            background: #171717;
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon" aria-hidden="true">
                    <svg viewBox="0 0 48 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 26V8L12 18L18 8V26" stroke="#0a0a0a" stroke-width="3.2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M24 9H38M31 9V26" stroke="#0a0a0a" stroke-width="3.2" stroke-linecap="round"/>
                    </svg>
                </div>
                <h1>Manuscript Tracker</h1>
            </div>
        </header>

        <div class="controls">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search manuscripts...">
            </div>
            <div class="sort-box">
                <select class="sort-select" id="sortSelect" aria-label="Sort manuscripts">
                    <option value="newest">Newest submissions</option>
                    <option value="oldest">Oldest submissions</option>
                    <option value="title">Title A - Z</option>
                    <option value="journal">Journal A - Z</option>
                    <option value="status">Status A - Z</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Manuscript
            </button>
            <button class="btn" onclick="exportData()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export
            </button>
        </div>

        <div class="manuscripts" id="manuscripts"></div>
    </div>

    <!-- Credits -->
    <footer class="credits">
        Made by IS &middot; <span id="creditsYear"></span>&trade;
    </footer>
    <div class="credits-subline">
        With
        <svg class="credits-heart" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 21C12 21 6 15.5 4 11.5C2 7.5 4.5 4 8 4C10 4 11.5 5.5 12 6.5C12.5 5.5 14 4 16 4C19.5 4 22 7.5 20 11.5C18 15.5 12 21 12 21Z"></path>
        </svg>
        and caffeine
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <h2 id="modalTitle">Add Manuscript</h2>
            <form id="form" onsubmit="saveManuscript(event)">
                <input type="hidden" id="manuscriptId">
                
                <div class="form-group">
                    <label class="form-label" for="title">Title</label>
                    <input type="text" class="form-input" id="title" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="journal">Journal / Conference</label>
                    <input type="text" class="form-input" id="journal" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="date">Date</label>
                    <input type="date" class="form-input" id="date" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="status">Status</label>
                    <select class="form-select" id="status">
                        <option value="draft">Draft</option>
                        <option value="submitted">Submitted</option>
                        <option value="review">Under Review</option>
                        <option value="revising">Revising</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                        <option value="published">Published</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes">Notes (optional)</label>
                    <textarea class="form-textarea" id="notes" placeholder="Additional notes..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="tagsInput">Tags</label>
                    <input type="text" class="form-input" id="tagsInput" placeholder="e.g. AI, collaboration, grant">
                    <div class="form-hint">Separate tags with commas (max 5 tags)</div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

            <script>
        const STATUS_LABELS = {
            draft: 'Draft',
            submitted: 'Submitted',
            review: 'Under Review',
            revising: 'Revising',
            accepted: 'Accepted',
            rejected: 'Rejected',
            published: 'Published'
        };
        const STATUS_OPTIONS = Object.keys(STATUS_LABELS);
        const FOLLOW_UP_STATUSES = ['submitted', 'review', 'revising'];
        const FOLLOW_UP_THRESHOLD_DAYS = 30;
        const DEFAULT_SORT = 'newest';

        let manuscripts = loadManuscripts();
        let editingId = null;

        function loadManuscripts() {
            try {
                const stored = localStorage.getItem('manuscripts');
                if (!stored) return [];
                const parsed = JSON.parse(stored);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Failed to parse manuscripts from storage', error);
                localStorage.removeItem('manuscripts');
                showToast('Saved data was invalid and has been reset.');
                return [];
            }
        }

        function toSafeString(value) {
            return value === undefined || value === null ? '' : String(value);
        }

        function escapeHTML(value) {
            return toSafeString(value).replace(/[&<>"']/g, (char) => {
                const entities = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return entities[char] || char;
            });
        }

        function formatNotes(value) {
            return escapeHTML(value).replace(/\r?\n/g, '<br>');
        }

        function parseTags(value) {
            return toSafeString(value)
                .split(',')
                .map(tag => tag.trim())
                .filter(Boolean)
                .slice(0, 5);
        }

        function renderTags(tags) {
            if (!tags || !tags.length) return '';
            const safeTags = tags.map(tag => `<span class="tag">${escapeHTML(tag)}</span>`).join('');
            return `<div class="card-tags">${safeTags}</div>`;
        }

        function sanitizeStatus(value) {
            const normalized = toSafeString(value).toLowerCase();
            return STATUS_OPTIONS.includes(normalized) ? normalized : STATUS_OPTIONS[0];
        }

        function formatStatusLabel(status) {
            return STATUS_LABELS[status] || STATUS_LABELS[STATUS_OPTIONS[0]];
        }

        function parseDateString(value) {
            if (!value) return null;
            const parts = value.split('-').map(Number);
            if (parts.length !== 3) return null;
            const [year, month, day] = parts;
            if (![year, month, day].every(Number.isInteger)) return null;
            const date = new Date(year, month - 1, day);
            if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return null;
            date.setHours(0, 0, 0, 0);
            return date;
        }

        function getDateValue(value) {
            const parsed = parseDateString(value);
            return parsed ? parsed.getTime() : 0;
        }

        function formatDateDetails(value) {
            const parsed = parseDateString(value);
            if (!parsed) return null;
            const formattedDate = parsed.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffDays = Math.floor((today - parsed) / (1000 * 60 * 60 * 24));
            let relativeText = '';
            if (diffDays === 0) relativeText = 'Today';
            else if (diffDays === 1) relativeText = 'Yesterday';
            else if (diffDays > 1) relativeText = `${diffDays} days ago`;
            else if (diffDays === -1) relativeText = 'Tomorrow';
            else relativeText = `In ${Math.abs(diffDays)} days`;
            return { formattedDate, relativeText, diffDays };
        }

        function needsFollowUp(status, diffDays) {
            return FOLLOW_UP_STATUSES.includes(status) && typeof diffDays === 'number' && diffDays >= FOLLOW_UP_THRESHOLD_DAYS;
        }

        function compareManuscripts(a, b, sortValue) {
            const sort = sortValue || DEFAULT_SORT;
            if (sort === 'oldest') {
                return getDateValue(a.date) - getDateValue(b.date);
            }
            if (sort === 'title') {
                return toSafeString(a.title).localeCompare(toSafeString(b.title), undefined, { sensitivity: 'base' });
            }
            if (sort === 'journal') {
                return toSafeString(a.journal).localeCompare(toSafeString(b.journal), undefined, { sensitivity: 'base' });
            }
            if (sort === 'status') {
                return sanitizeStatus(a.status).localeCompare(sanitizeStatus(b.status), undefined, { sensitivity: 'base' });
            }
            return getDateValue(b.date) - getDateValue(a.date);
        }

        function render() {
            const container = document.getElementById('manuscripts');
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const sortValue = document.getElementById('sortSelect')?.value || DEFAULT_SORT;
            
            const filtered = manuscripts.filter(m => {
                const title = toSafeString(m.title).toLowerCase();
                const journal = toSafeString(m.journal).toLowerCase();
                const notes = toSafeString(m.notes).toLowerCase();
                const tags = (m.tags || []).join(' ').toLowerCase();
                const status = sanitizeStatus(m.status).toLowerCase();
                return !searchTerm || title.includes(searchTerm) || journal.includes(searchTerm) || notes.includes(searchTerm) || tags.includes(searchTerm) || status.includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="32" cy="32" r="16" fill="none" stroke="white" stroke-width="3" opacity="0.2" />
                            <circle cx="32" cy="32" r="16" fill="none" stroke="#22c55e" stroke-width="3" 
                                    stroke-dasharray="75 25" stroke-dashoffset="0" stroke-linecap="round"
                                    transform="rotate(-90 32 32)" />
                            <path d="M26 32 L30 36 L38 28" stroke="white" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <h3>No manuscripts yet</h3>
                        <p>Click "Add Manuscript" to get started</p>
                    </div>
                `;
                return;
            }
            
            const sorted = [...filtered].sort((a, b) => compareManuscripts(a, b, sortValue));
            
            container.innerHTML = sorted.map(manuscript => {
                const safeTitle = escapeHTML(manuscript.title || 'Untitled manuscript');
                const safeJournal = escapeHTML(manuscript.journal || 'No venue specified');
                const statusKey = sanitizeStatus(manuscript.status);
                const statusLabel = formatStatusLabel(statusKey);
                const dateDetails = formatDateDetails(manuscript.date);
                const dateText = dateDetails ? `${dateDetails.formattedDate} &middot; ${dateDetails.relativeText}` : 'Date unavailable';
                const notesSection = manuscript.notes ? `<div class="card-notes">${formatNotes(manuscript.notes)}</div>` : '';
                const shouldFollowUp = dateDetails ? needsFollowUp(statusKey, dateDetails.diffDays) : false;
                const reminderBadge = shouldFollowUp ? `
                    <div class="reminder-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                        Follow up &middot; ${dateDetails.diffDays} days waiting
                    </div>
                ` : '';
                const cardClasses = ['card'];
                if (shouldFollowUp) cardClasses.push('card-reminder');
                
                return `
                    <div class="${cardClasses.join(' ')}" data-status="${statusKey}">
                        <div class="card-title">${safeTitle}</div>
                        <div class="card-journal">${safeJournal}</div>
                        <div class="card-date">${dateText}</div>
                        <span class="status-badge status-${statusKey}">
                            ${statusLabel}
                        </span>
                        ${reminderBadge}
                        ${renderTags(manuscript.tags)}
                        ${notesSection}
                        <div class="card-actions">
                            <button class="btn-card" onclick="editManuscript('${manuscript.id}')">Edit</button>
                            <button class="btn-card btn-delete" onclick="deleteManuscript('${manuscript.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openModal(manuscript = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('form');
            
            if (manuscript) {
                document.getElementById('modalTitle').textContent = 'Edit Manuscript';
                document.getElementById('title').value = toSafeString(manuscript.title);
                document.getElementById('journal').value = toSafeString(manuscript.journal);
                document.getElementById('date').value = toSafeString(manuscript.date);
                document.getElementById('status').value = sanitizeStatus(manuscript.status);
                document.getElementById('notes').value = toSafeString(manuscript.notes);
                document.getElementById('tagsInput').value = (manuscript.tags || []).join(', ');
                editingId = manuscript.id;
            } else {
                document.getElementById('modalTitle').textContent = 'Add Manuscript';
                form.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('status').value = STATUS_OPTIONS[0];
                document.getElementById('tagsInput').value = '';
                editingId = null;
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            editingId = null;
        }

        function saveManuscript(e) {
            e.preventDefault();

            const titleInput = document.getElementById('title');
            const journalInput = document.getElementById('journal');
            const dateInput = document.getElementById('date');
            const statusInput = document.getElementById('status');
            const notesInput = document.getElementById('notes');

            const title = titleInput.value.trim();
            const journal = journalInput.value.trim();
            const dateValue = dateInput.value;
            const status = sanitizeStatus(statusInput.value);
            const notes = notesInput.value.trim();

            if (!title || !journal || !dateValue) {
                showToast('Please fill in the required fields.');
                return;
            }

            const parsedDate = parseDateString(dateValue);
            if (!parsedDate) {
                showToast('Enter a valid date.');
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (parsedDate > today) {
                showToast('Submission date cannot be in the future.');
                return;
            }

            const normalizedTitle = title.toLowerCase();
            const duplicateTitle = manuscripts.some(m => m.id !== editingId && toSafeString(m.title).trim().toLowerCase() === normalizedTitle);
            if (duplicateTitle) {
                showToast('A manuscript with this title already exists.');
                return;
            }

            const isEditing = Boolean(editingId);
            const manuscript = {
                id: editingId || Date.now().toString(),
                title,
                journal,
                date: dateValue,
                status,
                notes,
                tags: parseTags(document.getElementById('tagsInput').value)
            };
            
            if (isEditing) {
                const index = manuscripts.findIndex(m => m.id === editingId);
                if (index >= 0) {
                    manuscripts[index] = manuscript;
                } else {
                    manuscripts.push(manuscript);
                }
            } else {
                manuscripts.push(manuscript);
            }
            
            localStorage.setItem('manuscripts', JSON.stringify(manuscripts));
            render();
            closeModal();
            showToast(isEditing ? 'Manuscript updated' : 'Manuscript added');
        }

        function editManuscript(id) {
            const manuscript = manuscripts.find(m => m.id === id);
            if (manuscript) openModal(manuscript);
        }

        function deleteManuscript(id) {
            if (confirm('Delete this manuscript?')) {
                manuscripts = manuscripts.filter(m => m.id !== id);
                localStorage.setItem('manuscripts', JSON.stringify(manuscripts));
                render();
                showToast('Manuscript deleted');
            }
        }

        function exportData() {
            const headers = ['Title', 'Journal/Conference', 'Date', 'Status', 'Notes'];
            const csvRows = [headers.map(h => `"${h}"`).join(',')];
            
            const sorted = [...manuscripts].sort((a, b) => compareManuscripts(a, b, DEFAULT_SORT));
            
            sorted.forEach(m => {
                const dateDetails = formatDateDetails(m.date);
                const row = [
                    toSafeString(m.title).trim(),
                    toSafeString(m.journal).trim(),
                    dateDetails ? dateDetails.formattedDate : '',
                    formatStatusLabel(sanitizeStatus(m.status)),
                    toSafeString(m.notes)
                ];
                const escaped = row.map(field => {
                    const safeField = field.replace(/\r?\n/g, ' ');
                    return `"${safeField.replace(/"/g, '""')}"`;
                });
                csvRows.push(escaped.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `manuscripts-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Data exported - paste into Word/Excel!');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.addEventListener('input', render);
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) sortSelect.addEventListener('change', render);
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        const creditsYear = document.getElementById('creditsYear');
        if (creditsYear) creditsYear.textContent = new Date().getFullYear();

        render();
    </script>
</body>
</html>
